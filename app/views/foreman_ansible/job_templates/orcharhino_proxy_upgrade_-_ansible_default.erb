<%#
name: orcharhino Proxy Upgrade Playbook
snippet: false
model: JobTemplate
job_category: Maintenance Operations
description_format: "%{template_name}"
provider_type: Ansible
kind: job_template
feature: ansible_run_orcharhino_proxy_upgrade
%>

---
- hosts: all
  tasks:
<% if plugin_present?('orcharhino_core') -%>
    - name: Gather RPM package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Fail if target is orcharhino Server
      ansible.builtin.fail:
        msg: "This playbook cannot be executed on orcharhino Server. Use only on orcharhino Proxy."
      when: "'orcharhino' in ansible_facts.packages"

    - block:
      - name: Update all packages on orcharhino Proxy
        ansible.builtin.package:
          name: "*"
          state: latest
        register: result

      - name: Run orcharhino-installer
        ansible.builtin.shell: orcharhino-installer
        register: result

      - name: Re-Gather RPM package facts after the upgrade
        ansible.builtin.package_facts:
          manager: auto

      - name: orcharhino-maintain upgrade return code is zero
        ansible.builtin.debug:
          msg: "Success! orcharhino Proxy upgrade completed. Current version of orcharhino Proxy is {{ ansible_facts.packages['orcharhino-proxy'][0]['version'] }}."

      rescue:
        - name: orcharhino-maintain upgrade return code is non-zero
          ansible.builtin.fail:
            msg: "Failed! orcharhino Proxy upgrade failed. For more information, see /var/log/foreman-installer/foreman-proxy-content.log on your orcharhino Proxy."
<% else -%>
    - name: Fail if orcharhino_core is missing
      ansible.builtin.fail:
        msg: "Failed! The plug-in orcharhino_core is not present. This playbook is only for use with orcharhino."
<% end -%>
